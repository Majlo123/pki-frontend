<div class="page-container">
    @if (successMessage()) {
        <div class="notification notification--success" role="alert">
            <strong class="notification__title">Uspeh!</strong>
            <span class="notification__message">{{ successMessage() }}</span>
        </div>
    }
    @if (errorMessage() && !showIssueModal() && !showAddCaUserModal() && !showRevokeModal() && !showTemplateModal()) {
        <div class="notification notification--error" role="alert">
            <strong class="notification__title">Greška!</strong>
            <span class="notification__message">{{ errorMessage() }}</span>
        </div>
    }

    <div class="page-header">
        <h1 class="page-header__title">Pregled Sertifikata</h1>
        <div class="page-header__actions">
            <button (click)="showAddCaUserModal.set(true)" class="btn btn--success">Dodaj CA Korisnika</button>
            <button (click)="openIssueModal()" class="btn btn--primary">Izdaj Sertifikat</button>
        </div>
    </div>

    <div class="certificate-table">
        <div class="certificate-table__wrapper">
            <table>
                <thead>
                    <tr>
                        <th scope="col">Status</th>
                        <th scope="col">Tip</th>
                        <th scope="col">Common Name (CN)</th>
                        <th scope="col">Serijski Broj</th>
                        <th scope="col">Važi do</th>
                        <th scope="col" class="cell--actions">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    @if(isLoading() && !certificates().length){
                        <tr><td colspan="6" class="table-message">Učitavanje...</td></tr>
                    }
                    @for(cert of certificates(); track cert.serialNumber){
                        <tr>
                            <td>
                                @if(cert.revoked) {
                                    <span class="status-badge status-badge--revoked">Povučen</span>
                                } @else {
                                    <span class="status-badge status-badge--active">Aktivan</span>
                                }
                            </td>
                            <td>{{cert.type}}</td>
                            <td class="cell--important">{{getCommonName(cert.subject)}}</td>
                            <td class="cell--monospace">{{cert.serialNumber}}</td>
                            <td>{{cert.validTo | date:'dd.MM.yyyy'}}</td>
                            <td class="cell--actions">
                                @if(!cert.revoked) {
                                    <button (click)="openRevokeModal(cert.serialNumber)" class="action-link">Povuci</button>
                                } @else {
                                    <span class="action-placeholder">Nema akcija</span>
                                }
                            </td>
                        </tr>
                    } @empty {
                        @if(!isLoading()){
                            <tr><td colspan="6" class="table-message">Nema sertifikata u sistemu.</td></tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- ===== NOVI DEO ZA ŠABLONE (sa ispravnim klasama) ===== -->
    <div class="page-header" style="margin-top: 3rem; border-top: 1px solid #374151; padding-top: 2rem;">
        <h2 class="page-header__title">Šabloni za Sertifikate</h2>
        <div class="page-header__actions">
             <button (click)="openTemplateModal()" class="btn btn--primary">Kreiraj Šablon</button>
        </div>
    </div>
    <div class="certificate-table">
        <div class="certificate-table__wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Naziv Šablona</th>
                        <th>Vreme Trajanja (dani)</th>
                        <th>Key Usage</th>
                        <th>Extended Key Usage</th>
                    </tr>
                </thead>
                <tbody>
                    @if(isLoading() && !templates().length){
                        <tr><td colspan="4" class="table-message">Učitavanje...</td></tr>
                    }
                    @for(template of templates(); track template.id){
                      <tr>
                        <td class="cell--important">{{ template.name }}</td>
                        <td>{{ template.timeToLiveDays }}</td>
                        <td class="cell--monospace">{{ template.keyUsage }}</td>
                        <td class="cell--monospace">{{ template.extendedKeyUsage }}</td>
                      </tr>
                    } @empty {
                        @if(!isLoading()){
                           <tr><td colspan="4" class="table-message">Nema kreiranih šablona.</td></tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ===== AŽURIRANI MODALI (sa ispravnim klasama) ===== -->
@if(showIssueModal()){
    <div class="modal">
        <div class="modal__backdrop" (click)="closeAllModals()"></div>
        <div class="modal__container modal__container--lg">
            <form #issueForm="ngForm" (ngSubmit)="onIssueCertificate()">
                <div class="modal__body">
                    <h3 class="modal__title">Izdavanje Novog Sertifikata</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Tip Sertifikata</label>
                            <select name="type" [(ngModel)]="issueModalData.type" class="form-control">
                                <option value="END_ENTITY">End-Entity</option>
                                <option value="INTERMEDIATE">Intermediate</option>
                                <option value="ROOT">Root</option>
                            </select>
                        </div>
                        <div class="form-group" [class.is-disabled]="issueModalData.type === 'ROOT'">
                            <label class="form-label">Izdavalac (CA)</label>
                            <select name="issuerSerialNumber" [(ngModel)]="issueModalData.issuerSerialNumber" [disabled]="issueModalData.type === 'ROOT'" class="form-control">
                                <option value="" disabled>Izaberite izdavaoca...</option>
                                @for(ca of caCertificates(); track ca.serialNumber){
                                    <option [value]="ca.serialNumber">{{ getCommonName(ca.subject) }}</option>
                                }
                            </select>
                        </div>
                        <input type="text" name="commonName" [(ngModel)]="issueModalData.subjectData.commonName" placeholder="Common Name (npr. www.sajt.com)" class="form-control" required>
                        <input type="text" name="organization" [(ngModel)]="issueModalData.subjectData.organization" placeholder="Organizacija" class="form-control" required>
                        <input type="text" name="organizationalUnit" [(ngModel)]="issueModalData.subjectData.organizationalUnit" placeholder="Organizaciona Jedinica" class="form-control" required>
                        <input type="text" name="country" [(ngModel)]="issueModalData.subjectData.country" placeholder="Država (kod)" class="form-control" required>
                        <div class="form-group form-group--full-width">
                            <input type="email" name="email" [(ngModel)]="issueModalData.subjectData.email" placeholder="Email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Važi Od</label>
                            <input type="date" name="validFrom" [(ngModel)]="issueModalData.validFrom" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Važi Do</label>
                            <input type="date" name="validTo" [(ngModel)]="issueModalData.validTo" class="form-control" required>
                        </div>
                    </div>
                    @if (errorMessage()) { <p class="error-message">{{ errorMessage() }}</p> }
                </div>
                <div class="modal__footer">
                    <button type="button" (click)="closeAllModals()" class="btn btn--secondary">Otkaži</button>
                    <button type="submit" [disabled]="isLoading() || issueForm.invalid" class="btn btn--primary">
                        @if(isLoading()){ <svg class="spinner" viewBox="0 0 24 24"></svg> Izdavanje... } @else { Izdaj }
                    </button>
                </div>
            </form>
        </div>
    </div>
}
@if(showAddCaUserModal()){
    <div class="modal">
        <div class="modal__backdrop" (click)="closeAllModals()"></div>
        <div class="modal__container modal__container--md">
            <form #addUserForm="ngForm" (ngSubmit)="onAddCaUser()">
                <div class="modal__body">
                    <h3 class="modal__title">Dodavanje Novog CA Korisnika</h3>
                    <div class="form-stacked">
                        <input type="email" name="email" [(ngModel)]="addCaUserData.email" placeholder="Email" class="form-control" required>
                        <input type="text" name="firstName" [(ngModel)]="addCaUserData.firstName" placeholder="Ime" class="form-control" required>
                        <input type="text" name="lastName" [(ngModel)]="addCaUserData.lastName" placeholder="Prezime" class="form-control" required>
                        <input type="text" name="organization" [(ngModel)]="addCaUserData.organization" placeholder="Organizacija" class="form-control" required>
                    </div>
                    @if (errorMessage()) { <p class="error-message">{{ errorMessage() }}</p> }
                </div>
                <div class="modal__footer">
                    <button type="button" (click)="closeAllModals()" class="btn btn--secondary">Otkaži</button>
                    <button type="submit" [disabled]="isLoading() || addUserForm.invalid" class="btn btn--success">
                        @if(isLoading()){ <svg class="spinner" viewBox="0 0 24 24"></svg> Dodavanje... } @else { Dodaj }
                    </button>
                </div>
            </form>
        </div>
    </div>
}
@if(showRevokeModal()){
    <div class="modal">
        <div class="modal__backdrop" (click)="closeAllModals()"></div>
        <div class="modal__container modal__container--md">
            <form #revokeForm="ngForm" (ngSubmit)="onRevokeCertificate()">
                <div class="modal__body">
                    <h3 class="modal__title">Povlačenje Sertifikata</h3>
                    <p class="modal__subtitle">Serijski broj: <span class="code">{{revokeModalData.serialNumber}}</span></p>
                    <div class="form-group">
                        <label class="form-label">Razlog povlačenja</label>
                        <select name="reason" [(ngModel)]="revokeModalData.reason" class="form-control">
                            <option>Unspecified</option>
                            <option>Key Compromise</option>
                            <option>CA Compromise</option>
                            <option>Affiliation Changed</option>
                            <option>Superseded</option>
                            <option>Cessation of Operation</option>
                        </select>
                    </div>
                    @if (errorMessage()) { <p class="error-message">{{ errorMessage() }}</p> }
                </div>
                <div class="modal__footer">
                    <button type="button" (click)="closeAllModals()" class="btn btn--secondary">Otkaži</button>
                    <button type="submit" [disabled]="isLoading()" class="btn btn--danger">
                        @if(isLoading()){ <svg class="spinner" viewBox="0 0 24 24"></svg> Povlačenje... } @else { Potvrdi Povlačenje }
                    </button>
                </div>
            </form>
        </div>
    </div>
}
@if(showTemplateModal()){
    <div class="modal">
        <div class="modal__backdrop" (click)="closeAllModals()"></div>
        <div class="modal__container">
            <form #templateForm="ngForm" (ngSubmit)="onCreateTemplate()">
              <div class="modal__body">
                <h3 class="modal__title">Kreiranje Novog Šablona</h3>
                <div class="form-stacked">
                 <input type="text" name="name" [(ngModel)]="templateModalData.name" placeholder="Naziv šablona" class="form-control" required>
                 <input type="text" name="commonNameRegex" [(ngModel)]="templateModalData.commonNameRegex" placeholder="Regex za Common Name" class="form-control">
                 <input type="number" name="timeToLiveDays" [(ngModel)]="templateModalData.timeToLiveDays" placeholder="Vreme trajanja (u danima)" class="form-control" required>
                 <input type="text" name="keyUsage" [(ngModel)]="templateModalData.keyUsage" placeholder="Key Usage (npr. digitalSignature)" class="form-control">
                 <input type="text" name="extendedKeyUsage" [(ngModel)]="templateModalData.extendedKeyUsage" placeholder="Extended Key Usage (npr. serverAuth)" class="form-control">
                </div>
              </div>
               @if (errorMessage()) { <p class="error-message">{{ errorMessage() }}</p> }
              <div class="modal__footer">
                <button type="button" (click)="closeAllModals()" class="btn btn--secondary">Otkaži</button>
                <button type="submit" [disabled]="isLoading() || templateForm.invalid" class="btn btn--primary">
                    @if(isLoading()){ Kreiranje... } @else { Kreiraj }
                </button>
              </div>
            </form>
          </div>
    </div>
}

