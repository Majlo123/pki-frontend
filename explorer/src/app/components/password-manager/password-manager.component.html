<div class="password-manager-container">
  <div class="header">
    <h2>Password Manager</h2>
    <p class="subtitle">Securely store and manage your passwords using PKI encryption</p>

    <!-- Statistics Cards -->
    <div class="stats-cards">
      <div class="stat-card">
        <h3>{{ stats.totalPasswordEntries }}</h3>
        <p>Stored Passwords</p>
      </div>
      <div class="stat-card">
        <h3>{{ stats.activeCertificates }}</h3>
        <p>Active Certificates</p>
      </div>
    </div>
  </div>

  <!-- Search and Add Section -->
  <div class="controls">
    <div class="search-section">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="searchEntries()"
        placeholder="Search by site name..."
        class="search-input"
      />
    </div>

    <button
      class="btn btn-primary"
      (click)="showAddForm = true"
      *ngIf="!showAddForm && !showEditForm"
    >
      Add New Password
    </button>
  </div>

  <!-- Certificate File Selection (for encryption/decryption) -->
  <div class="certificate-section" *ngIf="showAddForm || showEditForm">
    <div class="file-input-group">
      <label for="certificateFile">Select Certificate File (.p12):</label>
      <input
        type="file"
        id="certificateFile"
        accept=".p12,.pfx"
        (change)="onFileSelected($event)"
        class="file-input"
      />
      <small class="file-hint">Select your private key certificate file for encryption/decryption</small>
    </div>
  </div>

  <!-- Add Password Form -->
  <div class="form-section" *ngIf="showAddForm">
    <h3>Add New Password Entry</h3>
    <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label for="siteName">Site Name *</label>
          <input
            type="text"
            id="siteName"
            formControlName="siteName"
            placeholder="e.g., Gmail, GitHub"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label for="username">Username *</label>
          <input
            type="text"
            id="username"
            formControlName="username"
            placeholder="Username or email"
            class="form-control"
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="password">Password *</label>
          <input
            type="password"
            id="password"
            formControlName="password"
            placeholder="Password to encrypt and store"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label for="certificateId">Certificate for Encryption *</label>
          <select
            id="certificateId"
            formControlName="certificateId"
            class="form-control"
          >
            <option value="">Select a certificate</option>
            <option *ngFor="let cert of userCertificates" [value]="cert.id">
              {{ cert.subject }}
            </option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description (Optional)</label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="Optional description or notes"
          class="form-control"
          rows="3"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="!passwordForm.valid || !selectedFile">
          Save Password Entry
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelAdd()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Edit Password Form -->
  <div class="form-section" *ngIf="showEditForm && editingEntry">
    <h3>Edit Password Entry</h3>
    <form [formGroup]="editForm" (ngSubmit)="onUpdateSubmit()">
      <div class="form-row">
        <div class="form-group">
          <label for="editSiteName">Site Name *</label>
          <input
            type="text"
            id="editSiteName"
            formControlName="siteName"
            class="form-control"
          />
        </div>

        <div class="form-group">
          <label for="editUsername">Username *</label>
          <input
            type="text"
            id="editUsername"
            formControlName="username"
            class="form-control"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="editPassword">New Password (leave empty to keep current)</label>
        <input
          type="password"
          id="editPassword"
          formControlName="password"
          placeholder="Enter new password only if changing"
          class="form-control"
        />
      </div>

      <div class="form-group">
        <label for="editDescription">Description</label>
        <textarea
          id="editDescription"
          formControlName="description"
          class="form-control"
          rows="3"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="!editForm.valid">
          Update Password Entry
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Password Entries List -->
  <div class="entries-section" *ngIf="!showAddForm && !showEditForm">
    <h3>Your Password Entries ({{ filteredEntries.length }})</h3>

    <div class="entries-list" *ngIf="filteredEntries.length > 0">
      <div class="entry-card" *ngFor="let entry of filteredEntries">
        <div class="entry-header">
          <h4>{{ entry.siteName }}</h4>
          <div class="entry-actions">
            <button
              class="btn btn-sm btn-info"
              (click)="decryptPassword(entry)"
              title="Decrypt and view password"
            >
              üîì Decrypt
            </button>
            <button
              class="btn btn-sm btn-warning"
              (click)="editEntry(entry)"
              title="Edit entry"
            >
              ‚úèÔ∏è Edit
            </button>
            <button
              class="btn btn-sm btn-danger"
              (click)="deleteEntry(entry)"
              title="Delete entry"
            >
              üóëÔ∏è Delete
            </button>
          </div>
        </div>

        <div class="entry-details">
          <p><strong>Username:</strong> {{ entry.username }}</p>
          <p><strong>Certificate:</strong> {{ entry.certificateSubject }}</p>
          <p *ngIf="entry.description"><strong>Description:</strong> {{ entry.description }}</p>
          <p class="entry-meta">
            <small>
              Created: {{ entry.createdAt | date:'short' }} |
              Updated: {{ entry.updatedAt | date:'short' }}
            </small>
          </p>
        </div>
      </div>
    </div>

    <div class="no-entries" *ngIf="filteredEntries.length === 0 && passwordEntries.length === 0">
      <div class="empty-state">
        <h4>No Password Entries Found</h4>
        <p>You haven't stored any passwords yet. Click "Add New Password" to get started.</p>
        <p class="note">
          <strong>Note:</strong> Password manager is only available for EE (End Entity) users with active certificates.
        </p>
      </div>
    </div>

    <div class="no-results" *ngIf="filteredEntries.length === 0 && passwordEntries.length > 0">
      <div class="empty-state">
        <h4>No Matching Results</h4>
        <p>No password entries match your search term "{{ searchTerm }}".</p>
        <button class="btn btn-secondary" (click)="searchTerm = ''; searchEntries()">
          Clear Search
        </button>
      </div>
    </div>
  </div>
</div>

